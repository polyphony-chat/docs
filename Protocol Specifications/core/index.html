
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../Overviews/core/">
      
      
        <link rel="next" href="../chat/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/lines.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>polyproto - Polyphony</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#polyproto-specification" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Polyphony" class="md-header__button md-logo" aria-label="Polyphony" data-md-component="logo">
      
  <img src="../../assets/lines.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Polyphony
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              polyproto
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/polyphony-chat/polyproto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Overviews/core/" class="md-tabs__link">
          
  
    
  
  Overviews

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
    
  
  Protocol Specifications

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../APIs/" class="md-tabs__link">
          
  
    
  
  APIs

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Polyphony" class="md-nav__button md-logo" aria-label="Polyphony" data-md-component="logo">
      
  <img src="../../assets/lines.png" alt="logo">

    </a>
    Polyphony
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/polyphony-chat/polyproto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../blog/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    February 2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    November 2023
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/x509/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    X.509
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/chorus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    chorus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/polyphony/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    polyphony
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/polyproto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    polyproto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Overviews
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Overviews
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Overviews/core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    An Overview of polyproto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Protocol Specifications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Protocol Specifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    polyproto
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    polyproto
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-terminology-used-in-this-document" class="md-nav__link">
    <span class="md-ellipsis">
      1. Terminology used in this document
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-trust-model" class="md-nav__link">
    <span class="md-ellipsis">
      2. Trust model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-apis-and-communication-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      3. APIs and communication protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. APIs and communication protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#33-websockets" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 WebSockets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 WebSockets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-events-over-rest" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 Events over REST
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-federated-identity" class="md-nav__link">
    <span class="md-ellipsis">
      4. Federated identity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Federated identity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.1 Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#411-registering-a-new-actor-on-a-polyproto-home-server" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.1 Registering a new actor on a polyproto home server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#412-authenticating-a-new-client-on-a-polyproto-home-server" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.2 Authenticating a new client on a polyproto home server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#413-authenticating-on-a-foreign-server" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.3 Authenticating on a foreign server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-challenge-strings" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Challenge Strings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-abuse-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Abuse prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-users" class="md-nav__link">
    <span class="md-ellipsis">
      5. Users
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-encryption" class="md-nav__link">
    <span class="md-ellipsis">
      6. Encryption
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Encryption">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      6.1. KeyPackages
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.1. KeyPackages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#611-last-resort-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.1 Last resort KeyPackages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-initial-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Initial authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-multi-device-support" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Multi-device support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-keys-and-signatures" class="md-nav__link">
    <span class="md-ellipsis">
      7. Keys and signatures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Keys and signatures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Home server signed certificates for public client identity keys (ID-Cert)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.1 Home server signed certificates for public client identity keys (ID-Cert)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#711-structure-of-an-id-cert" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.1 Structure of an ID-Cert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#712-necessity-of-id-certs" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.2 Necessity of ID-Certs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#713-key-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.3 Key rotation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-actor-identity-keys-and-message-signing" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Actor identity keys and message signing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 Actor identity keys and message signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#722-message-verification" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.2 Message verification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 Best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#731-signing-keys-and-id-certs" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.1 Signing keys and ID-Certs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#732-home-server-operation-and-design" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.2 Home server operation and design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-account-migration" class="md-nav__link">
    <span class="md-ellipsis">
      8. Account migration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Account migration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-reassigning-ownership" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Reassigning ownership
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.1 Reassigning ownership">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#811-migrating-an-actor" class="md-nav__link">
    <span class="md-ellipsis">
      8.1.1 Migrating an actor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#812-re-signing-data" class="md-nav__link">
    <span class="md-ellipsis">
      8.1.2 Re-signing data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-moving-data" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Moving data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    <span class="md-ellipsis">
      Glossary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    polyproto-chat
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    APIs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            APIs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/Routes%3A%20Registration%20needed/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Routes: Registration needed
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_1">
            <span class="md-nav__icon md-icon"></span>
            Routes: Registration needed
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/Routes%3A%20No%20registration%20needed/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Routes: No registration needed
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_2">
            <span class="md-nav__icon md-icon"></span>
            Routes: No registration needed
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/WebSockets/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    WebSockets
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_2_3" id="__nav_5_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_3">
            <span class="md-nav__icon md-icon"></span>
            WebSockets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/WebSockets/gateway/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/WebSockets/gateway_events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway Events
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Errors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/rate-limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rate limits
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-terminology-used-in-this-document" class="md-nav__link">
    <span class="md-ellipsis">
      1. Terminology used in this document
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-trust-model" class="md-nav__link">
    <span class="md-ellipsis">
      2. Trust model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-apis-and-communication-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      3. APIs and communication protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. APIs and communication protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#33-websockets" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 WebSockets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 WebSockets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-events-over-rest" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 Events over REST
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-federated-identity" class="md-nav__link">
    <span class="md-ellipsis">
      4. Federated identity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Federated identity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.1 Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#411-registering-a-new-actor-on-a-polyproto-home-server" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.1 Registering a new actor on a polyproto home server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#412-authenticating-a-new-client-on-a-polyproto-home-server" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.2 Authenticating a new client on a polyproto home server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#413-authenticating-on-a-foreign-server" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.3 Authenticating on a foreign server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-challenge-strings" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Challenge Strings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-abuse-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Abuse prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-users" class="md-nav__link">
    <span class="md-ellipsis">
      5. Users
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-encryption" class="md-nav__link">
    <span class="md-ellipsis">
      6. Encryption
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Encryption">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      6.1. KeyPackages
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.1. KeyPackages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#611-last-resort-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.1 Last resort KeyPackages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-initial-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Initial authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-multi-device-support" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Multi-device support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-keys-and-signatures" class="md-nav__link">
    <span class="md-ellipsis">
      7. Keys and signatures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Keys and signatures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Home server signed certificates for public client identity keys (ID-Cert)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.1 Home server signed certificates for public client identity keys (ID-Cert)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#711-structure-of-an-id-cert" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.1 Structure of an ID-Cert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#712-necessity-of-id-certs" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.2 Necessity of ID-Certs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#713-key-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.3 Key rotation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-actor-identity-keys-and-message-signing" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Actor identity keys and message signing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 Actor identity keys and message signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#722-message-verification" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.2 Message verification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 Best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#731-signing-keys-and-id-certs" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.1 Signing keys and ID-Certs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#732-home-server-operation-and-design" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.2 Home server operation and design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-account-migration" class="md-nav__link">
    <span class="md-ellipsis">
      8. Account migration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Account migration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-reassigning-ownership" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Reassigning ownership
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.1 Reassigning ownership">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#811-migrating-an-actor" class="md-nav__link">
    <span class="md-ellipsis">
      8.1.1 Migrating an actor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#812-re-signing-data" class="md-nav__link">
    <span class="md-ellipsis">
      8.1.2 Re-signing data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-moving-data" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Moving data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    <span class="md-ellipsis">
      Glossary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="polyproto-specification">polyproto Specification<a class="headerlink" href="#polyproto-specification" title="Permanent link">&para;</a></h1>
<p><strong>v0.0.0</strong> - Treat this as an unfinished draft.
<a href="https://semver.org/spec/v2.0.0.html">Semantic versioning v2.0.0</a> is used to version this specification.
The version number specified here also applies to the API documentation.</p>
<ul>
<li><a href="#polyproto-specification">polyproto Specification</a></li>
<li><a href="#1-terminology-used-in-this-document">1. Terminology used in this document</a></li>
<li><a href="#2-trust-model">2. Trust model</a></li>
<li><a href="#3-apis-and-communication-protocols">3. APIs and communication protocols</a><ul>
<li><a href="#33-websockets">3.3 WebSockets</a></li>
<li><a href="#331-events-over-rest">3.3.1 Events over REST</a></li>
</ul>
</li>
<li><a href="#4-federated-identity">4. Federated identity</a><ul>
<li><a href="#41-authentication">4.1 Authentication</a></li>
<li><a href="#411-registering-a-new-actor-on-a-polyproto-home-server">4.1.1 Registering a new actor on a polyproto home server</a></li>
<li><a href="#412-authenticating-a-new-client-on-a-polyproto-home-server">4.1.2 Authenticating a new client on a polyproto home server</a></li>
<li><a href="#413-authenticating-on-a-foreign-server">4.1.3 Authenticating on a foreign server</a></li>
<li><a href="#42-challenge-strings">4.2 Challenge Strings</a></li>
<li><a href="#43-abuse-prevention">4.3 Abuse prevention</a></li>
</ul>
</li>
<li><a href="#5-users">5. Users</a></li>
<li><a href="#6-encryption">6. Encryption</a><ul>
<li><a href="#61-keypackages">6.1. KeyPackages</a></li>
<li><a href="#611-last-resort-keypackages">6.1.1 Last resort KeyPackages</a></li>
<li><a href="#62-initial-authentication">6.2 Initial authentication</a></li>
<li><a href="#63-multi-device-support">6.3 Multi-device support</a></li>
</ul>
</li>
<li><a href="#7-keys-and-signatures">7. Keys and signatures</a><ul>
<li><a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert">7.1 Home server signed certificates for public client identity keys (ID-Cert)</a></li>
<li><a href="#711-structure-of-an-id-cert">7.1.1 Structure of an ID-Cert</a><ul>
<li><a href="#7111-distinguished-names-dns">7.1.1.1 Distinguished Names (<code>DNs</code>)</a></li>
<li><a href="#7112-extensions-and-constraints">7.1.1.2 Extensions and constraints</a></li>
</ul>
</li>
<li><a href="#712-necessity-of-id-certs">7.1.2 Necessity of ID-Certs</a></li>
<li><a href="#713-key-rotation">7.1.3 Key rotation</a><ul>
<li><a href="#7131-a-note-about-crls-certificate-revocation-lists">7.1.3.1 A note about CRLs (Certificate revocation lists)</a></li>
</ul>
</li>
<li><a href="#72-actor-identity-keys-and-message-signing">7.2 Actor identity keys and message signing</a></li>
<li><a href="#722-message-verification">7.2.2 Message verification</a></li>
<li><a href="#73-best-practices">7.3 Best practices</a></li>
<li><a href="#731-signing-keys-and-id-certs">7.3.1 Signing keys and ID-Certs</a></li>
<li><a href="#732-home-server-operation-and-design">7.3.2 Home server operation and design</a></li>
</ul>
</li>
<li><a href="#8-account-migration">8. Account migration</a><ul>
<li><a href="#81-reassigning-ownership">8.1 Reassigning ownership</a></li>
<li><a href="#811-migrating-an-actor">8.1.1 Migrating an actor</a></li>
<li><a href="#812-re-signing-data">8.1.2 Re-signing data</a></li>
<li><a href="#82-moving-data">8.2 Moving data</a></li>
</ul>
</li>
</ul>
<p>The polyproto protocol is a home-server-based identity federation protocol specification intended for use in applications where actor identity is needed. polyproto focuses on federated identity, and apart from the usage of Messaging Layer Security (MLS) for encryption, does not specify any application-specific features. Instead, it is intended to be used as a base for application implementations and other protocols, such as <code>polyproto-chat</code> - a chat protocol built on top of polyproto. Through a shared "base layer", polyproto implementations are intercompatible in a way where one identity can be used across various polyproto implementations.</p>
<p>No part of polyproto is considered less important than any other part, and all parts of polyproto are required for a polyproto implementation to be considered compliant with the polyproto specification. The only exception to this is the encryption part of polyproto, which is optional, as the necessity of encryption depends on the specific implementation.</p>
<p>This document is intended to be used as a starting point for developers wanting to develop software, which can operate with other polyproto implementations.</p>
<h2 id="1-terminology-used-in-this-document">1. Terminology used in this document<a class="headerlink" href="#1-terminology-used-in-this-document" title="Permanent link">&para;</a></h2>
<p>In addition to the terminology found in the glossary located at the end of this document, the following terminology is used throughout this document:</p>
<ul>
<li><strong>Message, Messages</strong>: In the context of this protocol specification, a <strong>message</strong> is any piece of data sent by a client that is intended to be identifiable as being sent by a specific actor. To qualify as a "message", this piece of data must also, at any point in time, and also if only briefly, be visible to other users or to the unauthenticated public. Examples of things that would qualify as messages include:<ul>
<li>A message sent to another actor in a chat application</li>
<li>A post on a social media platform</li>
<li>A "like" interaction on a social media platform</li>
<li>Reaction emojis in Discord-like chat applications</li>
<li>Group join or leave messages</li>
<li>Reporting a post or actor, if the report is not anonymous</li>
</ul>
</li>
</ul>
<p>Terminology not specified in this section or in the glossary has been defined somewhere else in this document.</p>
<h2 id="2-trust-model">2. Trust model<a class="headerlink" href="#2-trust-model" title="Permanent link">&para;</a></h2>
<p>polyproto operates under the following trust assumptions:</p>
<ol>
<li>Users entrust their home server and its admins with data security and discretion on actions appearing as actor-performed.</li>
<li>Users only distrust their home servers in case of irregularities or conflicting information.</li>
<li>In a federated context, users trust foreign servers with all unencrypted data.</li>
<li>Users trust MLS channel members with their data and attached metadata.</li>
<li>Foreign servers cannot impersonate users without explicit consent.</li>
<li>Users rely on their home servers for identity key certification, without the home servers possessing the identity.</li>
</ol>
<h2 id="3-apis-and-communication-protocols">3. APIs and communication protocols<a class="headerlink" href="#3-apis-and-communication-protocols" title="Permanent link">&para;</a></h2>
<p>The polyproto specification defines a set of <a href="/APIs">APIs</a>.
In addition to these REST APIs, polyproto employs WebSockets for real-time communication between clients and servers.</p>
<h3 id="33-websockets">3.3 WebSockets<a class="headerlink" href="#33-websockets" title="Permanent link">&para;</a></h3>
<p>WebSockets enable real-time communication between actor clients and servers.</p>
<p>WebSocket connections to polyproto servers consist of the following cycle:</p>
<pre class="mermaid"><code>sequenceDiagram
autonumber

actor c as Client
participant g as Gateway

c-&gt;&gt;g: Establish connection
g-&gt;&gt;c: Recieve hello event

loop TODO: interval
  c-&gt;&gt;g: Send heartbeat event
  g-&gt;&gt;c: Send heartbeat ACK Event
end

c-&gt;&gt;g: Send identify payload

alt Server accepts
  g-&gt;&gt;c: Send ready event
else Server defined reason
  g-&gt;&gt;c: Disconnect with specified reason
end


opt Resume connection#59;&lt;br /&gt;otherwise, repeat from step 1
  c-&gt;&gt;g: Open new connection
  c-&gt;&gt;g: Send resume event
  g-&gt;&gt;c: Send missed events
  g-&gt;&gt;c: Send resumed event
end
</code></pre>
<p>Fig. 1: Sequence diagram of a WebSocket connection to a polyproto server.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>To learn more about polyproto WebSockets and WebSocket Events, consult the <a href="/docs/APIs/Core/WebSockets/index.md">WebSockets documentation</a>.</p>
</div>
<h4 id="331-events-over-rest">3.3.1 Events over REST<a class="headerlink" href="#331-events-over-rest" title="Permanent link">&para;</a></h4>
<p>For some implementation contexts, a constant WebSocket connection might not be wanted. A client can
instead opt to query an API endpoint to receive events, which would normally be sent through the WebSocket
connection. Concrete polyproto-implementations and extensions can decide whether this alternative
behaviour is supported. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>An example of an implementation context where having a constant WebSocket might not be wanted would
be Urban IoT devices, or devices with a limited or only periodically available internet connection. </p>
</div>
<p>Querying <a href="/APIs/Core/Routes%3A No registration needed/#get-events">this endpoint</a> yields a JSON-Array
containing either all events the session has missed since disconnecting from the WebSocket, or all events
the session has missed since last querying the endpoint.</p>
<p>Depending on how many events the session has
missed, the earliest events might be excluded from the response to limit the response bodies size. This
behaviour should be explicitly documented in implementations or extensions of polyproto.</p>
<p>Due to the
intended use cases for retrieving events through REST rather than WebSockets, this endpoint is not
a long-polling endpoint.</p>
<p>There are three intended, main modes for retrieving events in polyproto</p>
<ol>
<li>Keep a constant WebSocket connection whenever possible</li>
<li>Keep a semi-constant WebSocket connection, perhaps connecting every x minutes for a set period of
   time</li>
<li>Do not use WebSockets and only query the REST API</li>
</ol>
<p>Polling a REST endpoint is inherently inefficient and therefore should only be done with a high interval,
ranging from a few minutes to a few days. If a client requires information more often than that,
then a WebSocket connection should be considered.</p>
<h2 id="4-federated-identity">4. Federated identity<a class="headerlink" href="#4-federated-identity" title="Permanent link">&para;</a></h2>
<p>The federation of actor identities allows users to engage with foreign servers as if they were their home servers.
For instance, in polyproto-chat, an actor can send direct messages to users from a different server or join the Guilds of other servers.</p>
<p>Identity certificates defined in sections <a href="#7-keys-and-signatures">#7. Keys and signatures</a> and <a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert">#7.1 Home server signed certificates for public client identity keys (ID-Cert)</a> are employed to sign messages that the actor sends to other servers.</p>
<div class="admonition note">
<p class="admonition-title">Using one identity for several polyproto implementations</p>
<p>An actor can choose to use the same identity for multiple polyproto implementations. If section <a href="#413-authenticating-on-a-foreign-server">4.1.3</a> is implemented correctly, this should not be a problem.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You can read more about the Identity Pubkey and Certificate in <a href="#7-keys-and-signatures">7. Keys and signatures</a>.</p>
</div>
<h3 id="41-authentication">4.1 Authentication<a class="headerlink" href="#41-authentication" title="Permanent link">&para;</a></h3>
<h4 id="411-registering-a-new-actor-on-a-polyproto-home-server">4.1.1 Registering a new actor on a polyproto home server<a class="headerlink" href="#411-registering-a-new-actor-on-a-polyproto-home-server" title="Permanent link">&para;</a></h4>
<p>Registering a new actor in the context of polyproto is done through an API route defined in the polyproto <a href="/APIs/Core/Routes%3A No registration needed/#post-create-identity">"No registration needed" API</a> documentation.</p>
<p>To register, the client sends the necessary information to their home server. The server verifies the data, checks username availability, and responds with HTTP 201 and the new identity's federation ID, if successful. However, a session token is not provided until the actor authenticates a client, as detailed in section <a href="#412-authenticating-a-new-client-on-a-polyproto-home-server">4.1.2</a>.</p>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor c as Client
participant s as Server

c-&gt;&gt;s: Registration information
s-&gt;&gt;s: Verify correctness of provided information,&lt;br /&gt;check if username is available, etc

alt verification successful
  s-&gt;&gt;s: Verify provided CSR

  alt CSR okay
    s-&gt;&gt;s: Sign CSR
    s-&gt;&gt;c: HTTP status code 201, with actor federation ID
  end
end</code></pre>
Fig. 2: Sequence diagram of a successful identity creation process.</p>
<h4 id="412-authenticating-a-new-client-on-a-polyproto-home-server">4.1.2 Authenticating a new client on a polyproto home server<a class="headerlink" href="#412-authenticating-a-new-client-on-a-polyproto-home-server" title="Permanent link">&para;</a></h4>
<p>To access their account from a new device, an actor authenticates the session with their home server by sending authentication information and a <a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert">certificate signing request (CSR)</a> for the new client. If verified successfully, the server signs the CSR and responds with the newly generated ID-Cert and a session token corresponding to this ID-Cert.</p>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor c as Client
participant s as Server

c-&gt;&gt;s: Auth information, CSR
s-&gt;&gt;s: Verify correctness of provided auth information

alt Verified successfully
  s-&gt;&gt;s: Verify provided CSR
  alt CSR okay
  s-&gt;&gt;s: Sign CSR
  s-&gt;&gt;c: HTTP status code 201, ID-Cert + session token
  end
end
</code></pre>
Fig. 3: Sequence diagram of a successful client authentication process.</p>
<p>The client is now authenticated and can use the session token and ID-Cert to perform actions on behalf of the actor identified by the ID-Cert.</p>
<h4 id="413-authenticating-on-a-foreign-server">4.1.3 Authenticating on a foreign server<a class="headerlink" href="#413-authenticating-on-a-foreign-server" title="Permanent link">&para;</a></h4>
<p>Authenticating on a foreign server requires the actor to sign a challenge string with their private identity key and send it, along with their ID-Cert, to the server. The server then validates the ID-Cert's origin, the challenge string's signature, and the ID-Cert's validity.</p>
<p>If the verification is successful, the foreign server can issue a session token to the actor.</p>
<p><strong>Example:</strong>
Say that Alice is on server A, and wants to authenticate on Server B, using her existing identity.</p>
<p>Alice's client sends a request to Server B for a challenge string, telling Server B the session ID
they are communicating from in the process. Upon receiving a response, Alice signs this challenge
string with the correct private key. They then send the signature to Server B. Server B can now
verify that it was actually Alice who signed the string, and not a malicious outsider. Server B does
this by requesting Alice's ID-Cert, specifically the ID-Cert matching the session ID Alice
identified with to Server B. If all goes well, server B will send a newly generated session token
back to Alice's client. Alice's client can then authenticate with server B by using this token.</p>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor a as Alice
participant sb as Server B
participant sa as Server A

a-&gt;&gt;sb: Challenge string request including current Session ID
sb-&gt;&gt;a: Challenge string
a-&gt;&gt;sb: Signed challenge, ID-Cert, optional payload
sb-&gt;&gt;sa: Get Server A Public Certificate
sa-&gt;&gt;sb: Send Public Certificate
sb-&gt;&gt;sb: Verify signature of challenge string
sb-&gt;&gt;a: Session token, optional payload</code></pre>
Fig. 4: Sequence diagram of a successful identity verification.</p>
<p>In the diagram, Alice's "optional payload" is extra data that might be requested by servers. This is useful when using a single identity across various polyproto implementations, due to differing information needs. The payload is signed with the actor's private identity key.</p>
<p>Likewise, the "optional payload" sent by the server in the above diagram can be used by implementations to send additional information to the client. An example might be initial account information.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Alice currently has a polyproto identity, which she created when signing up for "https://example.com/chat". When signing up for this service, she didn't need to provide any additional information on registration. However, when she wants to actor her existing identity to sign up for "https://example.com/social", she is asked to provide her email address, which she can provide as the "optional payload". The server can then store the email address in its' database, associate it with Alice's identity, and let Alice log in with her existing identity. </p>
</div>
<p>If Alice's session token expires, they can repeat this process of requesting a challenge string and, together with her ID-Cert, exchange it for a session token.
However, if Alice wants to access this third party account from a completely new device, they will have to perform the steps described in section <a href="#412-authenticating-a-new-client-on-a-polyproto-home-server">4.1.2</a> to obtain a valid ID-Cert for that session.</p>
<h3 id="42-challenge-strings">4.2 Challenge Strings<a class="headerlink" href="#42-challenge-strings" title="Permanent link">&para;</a></h3>
<p>Servers generate alphanumeric challenge strings to verify an actor's private identity key possession. These strings, ranging from 32 to 256 characters, have a UNIX timestamp lifetime. If the current timestamp surpasses this lifetime, the challenge fails. The actor signs the string, sending the signature and their ID-Cert to the server, enabling identity confirmation.</p>
<p>Challenge strings counteract replay attacks. Their uniqueness ensures that even identical requests have different signatures, preventing malicious servers from successfully replaying requests.</p>
<h3 id="43-abuse-prevention">4.3 Abuse prevention<a class="headerlink" href="#43-abuse-prevention" title="Permanent link">&para;</a></h3>
<p>To protect users from malicious home servers secretly acting on the behalf of non-consenting users,
a mechanism is needed to prevent home servers from generating federation tokens for users without
their consent.</p>
<div class="admonition example">
<p class="admonition-title">Potential abuse scenario</p>
<p>A malicious home server can potentially request a federation token on behalf of one of its
users, and use it to generate a session token on the actor's behalf. This is a problem, as the
malicious server can then impersonate the actor on another server, as well as read unencrypted
data (such as messages, in the context of a chat application) sent on the other server.</p>
</div>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>The above scenario is not unique to polyproto, and rather a problem other federated services/
protocols, like ActivityPub, have as well. There is no real solution to this problem, but it can be
mitigated a bit by making it more difficult for malicious home servers to do something like this
without the actor noticing.</p>
</div>
<p>Polyproto servers need to inform users of new session tokens. This visibility hampers malicious home servers, but does not solve the issue of them being able to create federation tokens for servers the actor does not connect to. This is because, naturally, users cannot receive notifications without a connection. Clients re-establishing server connections must be updated on any new session tokens generated during their absence. The <code>NEW_SESSION</code> gateway event must be dispatched to all sessions, excluding the new session. The <code>NEW_SESSION</code> event's stored data can be accessed in the <a href="/docs/APIs/Core/WebSockets/gateway_events.md#new_session">Gateway Events documentation</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With proper safety precautions and strong encryption, it is extremely unlikely for a malicious
server to be able to listen in on encrypted conversations, without all users in that 
conversation noticing. MLS's forward secrecy guarantees ensure that, in theory, a malicious
session cannot decrypt any messages sent before its' join epoch. If secrecy or confidentiality
are of concern, users should host their own home server and use end-to-end encryption.</p>
</div>
<h2 id="5-users">5. Users<a class="headerlink" href="#5-users" title="Permanent link">&para;</a></h2>
<p>Every client requires an associated actor identity. Users are distinguished by a unique federation ID (FID), consist of their username, which is unique per instance, and the instance's root domain. This combination ensures global uniqueness.</p>
<p>FIDs used in public contexts are formatted as <code>actor@optionalsubdomain.domain.tld</code>, and are case-insensitive.</p>
<p>The following regular expression can be used to validate actor IDs: <code>\b([A-Z0-9._%+-]+)@([A-Z0-9.-]+\.[A-Z]{2,})\b</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Validating a federation ID with the above regex does not guarantee that the ID is valid. It only
indicates that the federation ID is formatted correctly.</p>
</div>
<p>For all intents and purposes, a federation ID is a display of identity. However, verifying identity
claims is crucial. See <a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert">Section #7.1</a>
and <a href="#722-message-verification">Section #7.2.2</a> for more information.</p>
<h2 id="6-encryption">6. Encryption<a class="headerlink" href="#6-encryption" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">About MLS</p>
<p>Polyproto offers end-to-end encryption for messages via <a href="https://messaginglayersecurity.rocks/">Message Layer Security (MLS)</a>. polyproto compliant servers take on the role of both an Authentication Service and a Delivery Service in the context of MLS.</p>
<p>MLS is a cryptographic protocol that provides confidentiality, integrity, and authenticity guarantees for group messaging applications. It builds on top of the <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet Algorithm</a> and <a href="https://signal.org/docs/specifications/x3dh/">X3DH</a> to provide these security guarantees.</p>
</div>
<p>Implementations of polyproto can opt to support encryption to secure communication channels. The selected security protocol for all polyproto implementations is the Messaging Layer Security protocol, given its feasibility within the implementation context. MLS inherently supports negotiation of protocol versions, cipher suites, extensions, credential types, and extra proposal types. For two implementations of polyproto to be compatible with each other in the context of encryption, they must have overlapping capabilities in these areas.</p>
<p>The following sections explain the additional behavior that polyproto implementations utilizing MLS must implement.</p>
<h3 id="61-keypackages">6.1. KeyPackages<a class="headerlink" href="#61-keypackages" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The sections 6.1 and 6.1.1 are not exhaustive and do not cover all aspects of MLS and KeyPackages. They exist solely to give a general overview of how KeyPackages are used in polyproto.
Please read and understand the MLS specification (RFC9420) to implement polyproto correctly.</p>
</div>
<p>A polyproto compliant server must store KeyPackages for all clients registered on it. The KeyPackage is a JSON object that contains the following information:</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span><span class="nt">&quot;protocol_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Version&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="nt">&quot;cipher_suite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;CipherSuite&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">&quot;init_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;HPKEPublicKey&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="nt">&quot;leaf_node&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;LeafNode&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="nt">&quot;extensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Extensions&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li><code>protocol_version</code> denotes the MLS protocol version.</li>
<li><code>cipher_suite</code> indicates the used cipher suite for this KeyPackage. Note that a server can store many KeyPackages for a single actor, to support various cipher suites.</li>
<li><code>init_key</code> is a public key for encrypting initial group secrets.</li>
<li><code>leaf_node</code> is a signed <code>LeafNodeTBS</code> struct as defined in section <code>7.2. Leaf Node Contents</code> in RFC9420. A <code>LeafNode</code> has information representing a users' identity, in the form of the users' <strong>ID-Cert</strong> for a given session or client. The <code>LeafNodeTBS</code> is signed by using the actor's private identity key.</li>
<li><code>extensions</code> can be used to add additional information to the protocol, as defined in section <code>13. Extensibility</code> in RFC9420.</li>
</ul>
<p>A KeyPackage is supposed to be used only once. Servers must ensure the following things:
-  That any KeyPackage is not given out to clients more than once.
-  That the <code>init_key</code> values of all KeyPackages are unique, as the <code>init_key</code> is what makes the KeyPackage one-time use.
-  That the contents of the <code>LeafNode</code> and the <code>init_key</code> were signed by the actor who submitted the KeyPackage.</p>
<p>Because KeyPackages are supposed to be used only once, servers should retain multiple valid KeyPackages for each actor, alerting clients when their stock is running low. Consult the <a href="/APIs/Core/Routes%3A Registration needed">"Registration needed"-API</a> for more information about how servers should request new KeyPackages from clients. Servers should delete KeyPackages when their validity lapses.</p>
<p>Servers only store KeyPackages for home server users, not for foreign users.</p>
<div class="admonition note">
<p class="admonition-title">About keys</p>
<p>It is recommended that keys are generated using the <code>EdDSA</code> signature scheme, however, other signature schemes may be used as well.
Consider, that intercompatibility can only be guaranteed if all communicating parties have an overlapping set of supported signature schemes.</p>
</div>
<h4 id="611-last-resort-keypackages">6.1.1 Last resort KeyPackages<a class="headerlink" href="#611-last-resort-keypackages" title="Permanent link">&para;</a></h4>
<p>A "last resort" KeyPackage, which, contrasting regular KeyPackages, is reusable, is issued when a server runs out of regular KeyPackages for an actor. This is to prevent <code>DoS</code> attacks, where malicious clients deplete all KeyPackages for a given actor, blocking that actor's inclusion into encrypted groups or guild channels.</p>
<p>Servers are to replace a "last resort" KeyPackage after it has been used at least once by requesting one from the client.</p>
<h3 id="62-initial-authentication">6.2 Initial authentication<a class="headerlink" href="#62-initial-authentication" title="Permanent link">&para;</a></h3>
<p>During the initial authentication process, a client must provide at least one <a href="#61-keypackages">KeyPackage</a> and one <a href="#611-last-resort-keypackages">"last resort" KeyPackage</a> to the server, in addition to the required registration information.</p>
<p>The public identity key inside the <code>LeafNode</code> of this KeyPackage corresponds to the public identity key found inside a clients' ID-Cert.</p>
<h3 id="63-multi-device-support">6.3 Multi-device support<a class="headerlink" href="#63-multi-device-support" title="Permanent link">&para;</a></h3>
<p>polyproto servers and clients employing encryption must support multi-device use. The MLS protocol assigns each device a unique <code>LeafNode</code> and prohibits key sharing across devices. Each device offers distinct KeyPackages and an own ID-Cert.</p>
<h2 id="7-keys-and-signatures">7. Keys and signatures<a class="headerlink" href="#7-keys-and-signatures" title="Permanent link">&para;</a></h2>
<h3 id="71-home-server-signed-certificates-for-public-client-identity-keys-id-cert">7.1 Home server signed certificates for public client identity keys (ID-Cert)<a class="headerlink" href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert" title="Permanent link">&para;</a></h3>
<p>The ID-Cert, a <a href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificate, validates a public actor identity key. It is an actor-generated CSR (<a href="https://en.wikipedia.org/wiki/Certificate_signing_request">Certificate Signing Request</a>), signed by a home server, encompassing actor identity information and the client's public identity key. Clients can get an ID-Cert in return for a valid and well-formed CSR.</p>
<p>All ID-Certs are valid X.509 certificates. However, not all X.509 certificates are valid ID-Certs.</p>
<p>ID-Certs form the basis of message signing and verification in polyproto.
They are used to verify the identity of a client, and to verify the integrity of messages sent by a
client.</p>
<p>A CSR includes the following information, according to the X.509 standard:</p>
<ul>
<li>The public identity key of the client.</li>
<li>The federation ID of the actor associated with the client.</li>
<li>The session ID of the client. The session ID is a unique identifier for a session, which does not change when a client rotates their identity keys.</li>
<li>Optionally, an expiry date for the certificate. This expiry date must be less than or equal to the expiry date of the home servers' public identity key certificate.</li>
</ul>
<p>When signing a CSR, the home server must verify the correctness of all claims presented in the CSR.</p>
<div class="admonition warning">
<p class="admonition-title">Important</p>
<p>All entities receiving an ID-Cert must inspect the certificate for correctness and validity. 
This includes checking the signature, the certificate's validity period, the certificate's issuer
and <strong>all</strong> other claims presented in the certificate.</p>
</div>
<div class="admonition bug">
<p class="admonition-title">TODO</p>
<p>TODO: "Session ID" should be stored in DN as UID, "Subject Unique Identifier" should be full federation ID (or left out?)</p>
<p>As per the polyproto crate documentation:</p>
<div class="language-rs highlight"><span class="filename">Rust</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="sd">/// [Name] must meet the following criteria to be valid in the context of polyproto:</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="sd">/// - Distinguished name MUST have &quot;common name&quot; attribute, which is equal to the actor or</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="sd">///   home server name of the subject in question. Only one &quot;common name&quot; is allowed.</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="sd">/// - MUST have AT LEAST one domain component, specifying the home server subdomain for this</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="sd">///   entity.</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="sd">/// - If actor name, MUST include UID (OID 0.9.2342.19200300.100.1.1) and uniqueIdentifier</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="sd">///   (OID 0.9.2342.19200300.100.1.44).</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="sd">///     - UID is the federation ID of the actor.</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="sd">///     - uniqueIdentifier is the [SessionId] of the actor.</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="sd">/// - MAY have &quot;organizational unit&quot; attributes</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">/// - MAY have other attributes, which might be ignored by other home servers and other clients.</span>
</code></pre></div>
</div>
<p>The resulting ID-Cert then holds the following information:</p>
<table>
<thead>
<tr>
<th>Field Description</th>
<th>Special requirements, if any</th>
<th>X.509 equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td>The home servers' fully qualified domain name.</td>
<td><a href="#7111-distinguished-names-dns">Distinguished Name</a></td>
<td>Issuer Name</td>
</tr>
<tr>
<td>The federation ID of the actor.</td>
<td><a href="#7111-distinguished-names-dns">Distinguished Name</a>, Must be unique across all actors on the home server.</td>
<td>Subject Name</td>
</tr>
<tr>
<td>A unique identifier for the certificate.</td>
<td>Must be unique across all certificates issued by a home server.</td>
<td>Serial Number</td>
</tr>
<tr>
<td>The algorithm used to sign the certificate.</td>
<td></td>
<td>Certificate Signature Algorithm &amp; Signature Algorithm ID</td>
</tr>
<tr>
<td>The signature of the certificate, generated by using the home servers' private identity key.</td>
<td></td>
<td>Certificate Signature</td>
</tr>
<tr>
<td>The expiry date of the certificate.</td>
<td>Time must not be after expiry date of the home server's root certificate</td>
<td>Validity period: Not After</td>
</tr>
<tr>
<td>Certificate validity period starting date</td>
<td>Time must not be before the home server's root certificate was generated</td>
<td>Validity period: Not Before</td>
</tr>
<tr>
<td>X.509 Version Number (v3)</td>
<td>v3</td>
<td>Version Number</td>
</tr>
<tr>
<td>The public identity key of the client.</td>
<td></td>
<td>Subject Public Key Info: Subject Public Key</td>
</tr>
<tr>
<td>The public key algorithm used to generate the client's public identity key.</td>
<td></td>
<td>Subject Public Key Info: Public Key Algorithm</td>
</tr>
<tr>
<td>The session ID of the client.</td>
<td>No two valid certificates for one session ID can exist. Session IDs have to be unique per user.</td>
<td>Subject Unique Identifier</td>
</tr>
<tr>
<td>Extensions</td>
<td></td>
<td>Extensions</td>
</tr>
</tbody>
</table>
<h4 id="711-structure-of-an-id-cert">7.1.1 Structure of an ID-Cert<a class="headerlink" href="#711-structure-of-an-id-cert" title="Permanent link">&para;</a></h4>
<p>The ID-Cert is a valid X.509 certificate, and as such, it has a specific structure. The structure of
an X.509 certificate is defined in <a href="https://tools.ietf.org/html/rfc5280">RFC5280</a>.
ID-Certs encompass a subset of the structure of an X.509 certificate.</p>
<h5 id="7111-distinguished-names-dns">7.1.1.1 Distinguished Names (<code>DNs</code>)<a class="headerlink" href="#7111-distinguished-names-dns" title="Permanent link">&para;</a></h5>
<p>The Distinguished Names (<code>DNs</code>), according to the <a href="https://en.wikipedia.org/wiki/LDAP_Data_Interchange_Format">LDAP Data Interchange Format (LDIF)</a>. The <code>DN</code> is a sequence of relative distinguished names (<code>RDNs</code>).</p>
<p>The distinguished name must be unique for each certificate issued by a home server. The <code>DN</code> of an ID-Cert
must include the following fields:</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>dn: cn=&lt;actor or home server name&gt;, dc=&lt;home server subdomain, if any&gt;, dc=&lt;home server domain&gt;, dc=&lt;hosme server tld, if any&gt;
</code></pre></div>
<p>If the home server does not have a subdomain or tld, the <code>dc</code> fields for these components should
be omitted. </p>
<p>Optionally, the <code>DN</code> can include an <code>ou</code> field, representing the organizational unit of the actor.</p>
<h5 id="7112-extensions-and-constraints">7.1.1.2 Extensions and constraints<a class="headerlink" href="#7112-extensions-and-constraints" title="Permanent link">&para;</a></h5>
<p>The following constraints must be met by ID-Certs:</p>
<ul>
<li>If the ID-Cert is a root certificate</li>
<li>It must have the <code>CA</code> flag set to <code>true</code>. The path length constraint must be set to <code>0</code>.</li>
<li>It must have the <code>keyCertSign</code> and <code>cRLSign</code> key usage flags set to <code>true</code>.</li>
<li>If the ID-Cert is an actor certificate</li>
<li>It must have the <code>CA</code> flag set to <code>false</code>.</li>
<li>It must have the <code>keyCertSign</code> and <code>cRLSign</code> key usage flags set to <code>false</code>.</li>
<li>It must have the <code>digitalSignature</code> key usage flag set to <code>true</code>.</li>
</ul>
<h4 id="712-necessity-of-id-certs">7.1.2 Necessity of ID-Certs<a class="headerlink" href="#712-necessity-of-id-certs" title="Permanent link">&para;</a></h4>
<p>The addition of a certificate might seem ubiquitous, but it is necessary to prevent a malicious foreign server from abusing public identity key caching to impersonate an actor. Consider the following example which employs foreign server public identity key caching, but no home server issued identity key certificates:</p>
<div class="admonition example">
<p class="admonition-title">Potential abuse scenario</p>
<p>A malicious foreign server B can fake a message from Alice (Home server: Server A) to Bob (Home Server: Server B), by generating a new identity key pair and using it to sign the malicious message. The foreign server then sends that message to Bob, who will then request Alice's public identity key from Server B, who will then send Bob the malicious public identity key. Bob will succeed in verifying the signature of the message, and not notice that the message is malicious.</p>
</div>
<p>The above scenario is not possible with home server issued identity key certificates, as the malicious server cannot generate an identity key pair for Alice, which is signed by Server A.</p>
<h4 id="713-key-rotation">7.1.3 Key rotation<a class="headerlink" href="#713-key-rotation" title="Permanent link">&para;</a></h4>
<p>A session may choose to rotate their ID-Cert at any time. This is done by generating a new identity key pair, using the new private key to generate a new CSR, and sending the new Certificate Signing Request to the home server, along with at least one new KeyPackage and a corresponding 'last resort' KeyPackage. The home server will then generate the new ID-Cert, send it to the client, and let all associated clients know that this clients' public identity key has changed. The server does this by sending a <a href="/docs/APIs/Core/WebSockets/gateway_events.md#client_key_change"><code>CLIENT_KEY_CHANGE</code></a> gateway event to those clients.</p>
<p>For example, in the context of a chat application built with polyproto-chat, an associating relationship between two clients exists, if:</p>
<ul>
<li>the two clients share a guild, a group or a direct message channel</li>
<li>they are friends</li>
<li>they have a pending friend request between each other.</li>
</ul>
<p>Rotating keys is done by using an API route which requires authorization. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sessions can request a new ID-Cert for any session of the same actor. Most other, currently existing
services also allow for this, as it is a common use case for user to want to, perhaps, log out of
devices they no longer use. Depending on your use case, this might be a security concern, as it
potentially simplifies account takeovers. Whether and how this risk is mitigated is up to 
concrete implementations.</p>
</div>
<p>Before sending any messages to a server, a client that performed a key rotation should inform the server of that change. This is to ensure that the server has cached the correct ID-Cert for this session.</p>
<p>Home servers must keep track of the ID-Certs of all users (and their clients) registered on them, and must provide a clients' ID-Cert for a given timestamp on request. This is to ensure messages sent by users, even ones sent a long time ago, can be verified by other servers and their users. This is because the public key of an actor likely changes over time and users must sign all messages they send to servers. Likewise, a client should also keep all of its own ID-Certs stored perpetually, to potentially verify its identity in case of a migration.</p>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor c as Client
participant s as Server

c-&gt;&gt;c: Create CSR for own identity key
c-&gt;&gt;s: Request key rotation/CSR signing, CSR attached
s-&gt;&gt;s: Verify validity of claims presented in the CSR
alt verify success
  s-&gt;&gt;s: Create ID-Cert for Client
  s-&gt;&gt;c: Respond with ID-Cert
end
Note right of s: Send CLIENT_KEY_CHANGE to associated clients</code></pre>
Fig. 5: Sequence diagram depicting the process of a client using a CSR to request a new ID-Cert from their home server.</p>
<p>A server identity key's lifetime might come to an early or unexpected end, perhaps due to some sort of leak of the corresponding private key. When this happens, the server should generate a new identity key pair and broadcast the <a href="/docs/APIs/Core/WebSockets/gateway_events.md#server_key_change"><code>SERVER_KEY_CHANGE</code></a> and <a href="/docs/APIs/Core/WebSockets/gateway_events.md#low_key_packages"><code>LOW_KEY_PACKAGES</code></a> gateway events to all clients. Clients should regenerate their identity keys, request a new ID-Cert (through a CSR), and respond appropriately to the <a href="/docs/APIs/Core/WebSockets/gateway_events.md#low_key_packages"><code>LOW_KEY_PACKAGES</code></a> event. Should a client be offline at the time of the key change, it must be informed of the change upon reconnection.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A <code>LOW_KEY_PACKAGES</code> event is only sent by servers which use MLS encryption. Server/Clients not implementing MLS encryption can safely ignore this event.</p>
</div>
<h5 id="7131-a-note-about-crls-certificate-revocation-lists">7.1.3.1 A note about CRLs (Certificate revocation lists)<a class="headerlink" href="#7131-a-note-about-crls-certificate-revocation-lists" title="Permanent link">&para;</a></h5>
<p>It is common for systems relying on X.509 certificates for user authentication to use Certificate
Revocation Lists (CRLs) to keep track of which certificates are no longer valid. This is done to
prevent a user from using a certificate that has been revoked.</p>
<p>CRLs are difficult to implement well, often requiring many resources to keep up to date, and
are also not always reliable. OCSP (Online Certificate Status Protocol) is a more modern, reliable
and easier to implement alternative. Still, it potentially requires many resources to
keep up with demand, while introducing a more immediate single point of failure.</p>
<p>polyproto inherently mitigates some of the possible misuse of a revoked certificate, as the validity
of a certificate is usually checked by many parties. Especially, if the revocation process is
initiated by the actor themselves, the actor already lets all servers they are connected to know that
the certificate in question is no longer valid.</p>
<p>polyproto does not require the use of CRLs or OCSP.</p>
<h3 id="72-actor-identity-keys-and-message-signing">7.2 Actor identity keys and message signing<a class="headerlink" href="#72-actor-identity-keys-and-message-signing" title="Permanent link">&para;</a></h3>
<p>As briefly mentioned section <a href="#4-federated-identity">#4</a>, users must hold on to an identity key pair at all times. This key pair is used to represent an actor's identity and to verify message integrity, by having an actor sign all messages they send with their private identity key. The key pair is generated by the actor. An actor-generated identity key certificate signing request (CSR) is sent to the actor's home server when first connecting to the server with a new session, or when rotating keys. The key is stored in the client's local storage. Upon receiving a new identity key CSR, a home server will sign this CSR and send the resulting ID-Cert to the client. This certificate is proof that the home server attests to the clients key. Read <a href="#71-home-server-signed-certificates-for-public-client-identity-keys-id-cert">section 7.1</a> for more information on the certificate.</p>
<h4 id="722-message-verification">7.2.2 Message verification<a class="headerlink" href="#722-message-verification" title="Permanent link">&para;</a></h4>
<div class="admonition bug">
<p class="admonition-title">TODO</p>
<p>TODO: Add notice about checking for signature malleability when verifying messages.</p>
</div>
<div class="admonition bug">
<p class="admonition-title">TODO</p>
<p>TODO: Add the information that PKCS#10 is used for CSRs, and that CSRs are DER encoded.</p>
</div>
<p>To ensure message integrity via signing, clients and servers must verify message signatures. This involves cross-checking the message signature against the sender's ID-Cert and the senders' home server's root certificate, while also confirming the validity of the ID-Cert attached to the message and ensuring its public key matches the sender's.</p>
<p><strong>Example:</strong> Given a signed message from Alice, such as Bob would receive from Server B in <a href="#fig-3">Fig. 3</a>, Bob's client would verify the signature of the message like this:</p>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor b as Bob
participant sa as Server A
participant sb as Server B

sb-&gt;&gt;b: Alice's signed message
b-&gt;&gt;sb: Request Alice's ID-Cert
sb-&gt;&gt;b: Alice's ID-Cert
b-&gt;&gt;sa: Request Server A ID-Cert
sa-&gt;&gt;b: Server A ID-Cert
b-&gt;&gt;b: Verify signature of Alice's message
</code></pre>
Fig. 6: Sequence diagram of a successful message signature verification.</p>
<p>Bob's client and Server B should now cache Server A's public identity key and Alice's ID-Cert,
to avoid having to request them again.</p>
<p>If the verification fails, Bob's client should try to re-request the key from Server B first. Should the verification fail again, Bob's client can try to request Alice's public identity key and ID-Cert from Server A (Alice's home server). The signature verification process should then be re-tried. Should the verification still not succeed, the message should be treated with extreme caution.</p>
<div class="admonition question">
<p class="admonition-title">Why does Bob's client not request Alice's public identity key from Server A?</p>
<p>Bob's client could request Alice's public identity key from Server A, instead of Server B. However, this is discouraged, as it</p>
<ul>
<li>Generates unnecessary load on Server A; Doing it this way distributes the load of public identity key requests more fairly, as the server that the message was sent on is the one that has to process the bulk of public identity key requests.</li>
<li>Would expose unnecessary metadata to Server A; Server A does not need to know who exactly Alice is talking to, and when. Only Server B, Alice and Bob need to know this information. Always requesting the public identity key from Server A might expose this information to Server A.</li>
</ul>
<p>Clients should only use Server A as a fallback for public identity key verification, if Server B does not respond to the request for Alice's public identity key, or if the verification fails with the public identity key from Server B.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>A failed signature verification does not always mean that the message is invalid. It may be that the actor's identity key has changed, and that Server B has not yet received the new public identity key for some reason.</p>
</div>
<h3 id="73-best-practices">7.3 Best practices<a class="headerlink" href="#73-best-practices" title="Permanent link">&para;</a></h3>
<h4 id="731-signing-keys-and-id-certs">7.3.1 Signing keys and ID-Certs<a class="headerlink" href="#731-signing-keys-and-id-certs" title="Permanent link">&para;</a></h4>
<ul>
<li>Actor and client signing keys should be rotated regularly (every 20-60 days). This is to ensure that a compromised key can only be used for a limited amount of time. Server identity keys should be rotated way less often (every 1-5 years), and perhaps only when a leak is suspected.</li>
<li>When a server is asked to generate a new ID-Cert for an actor, it must make sure that the CSR is valid and, if set, has an expiry date less than or equal to the expiry date of the server's own ID-Cert.</li>
<li>Due to the fact that a <code>SERVER_KEY_CHANGE</code> gateway event is bound to generate a large amount of traffic, servers should only manually generate a new identity key pair when absolutely necessary and instead choose a fitting expiry date interval for their identity key certificates. It might also be a good idea to stagger the sending of <code>SERVER_KEY_CHANGE</code> gateway events, to prevent a server from initiating a DDoS attack on itself.</li>
<li>When a client or server receives the information that an actor's client identity key has been changed, the client/server in question should update their cached ID-Cert for the actor in question, taking into account the session ID of the new identity key pair.</li>
</ul>
<h4 id="732-home-server-operation-and-design">7.3.2 Home server operation and design<a class="headerlink" href="#732-home-server-operation-and-design" title="Permanent link">&para;</a></h4>
<ul>
<li>Use a caching layer for your home server to handle the potentially large amount of requests for
  ID-Certs without putting unnecessary strain on the database.</li>
</ul>
<h2 id="8-account-migration">8. Account migration<a class="headerlink" href="#8-account-migration" title="Permanent link">&para;</a></h2>
<p>Account migration allows users to move their account and associated data to another identity.
This allows users to switch home servers while not losing ownership of messages sent by them.</p>
<p>Migrating an actor always involves reassigning the ownership of all actor-associated data in the
distributed network to the new actor. Should the old actor want to additionally move all data from
the old home server to another home server, more steps are needed. </p>
<h3 id="81-reassigning-ownership">8.1 Reassigning ownership<a class="headerlink" href="#81-reassigning-ownership" title="Permanent link">&para;</a></h3>
<p>Migrating an account is done with the following steps:</p>
<ol>
<li>The actor creates a new account on a new home server.</li>
<li>The actor requests the migration from the new home server, specifying the old account's
   federation ID.</li>
<li>The old actor account confirms the migration request by sending a signed API request to the new home
   server. The confirmation contains the federation ID of the new account.</li>
<li>The new server sends this information to the old server, which then sends the new server all
   information associated with the old account. 
   The old server now forward requests regarding the old account to the new server.
   Alternatively, if the old server is shut down, the new server can request the information
   from the old actor directly.</li>
<li>The old account can now request the resigning of its messages, transferring ownership of the
   messages to the new account. To have all messages from a server re-signed, an actor must
   prove that they are the owner of the private keys used to sign the messages.</li>
</ol>
<h4 id="811-migrating-an-actor">8.1.1 Migrating an actor<a class="headerlink" href="#811-migrating-an-actor" title="Permanent link">&para;</a></h4>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor aa as Alice A
actor ab as Alice B
participant sa as Server A
participant sb as Server B

ab-&gt;&gt;sb: Migration request (signed, Alice B-&gt;Server B)
aa-&gt;&gt;sb: Migration request (signed, Alice A-&gt;Server B)
sb-&gt;&gt;sa: Fetch full profile of Alice A,&lt;br /&gt;attached with migration request
sa-&gt;&gt;sa: Verify signed migration request
sa-&gt;&gt;sb: Full profile of Alice A
sb-&gt;&gt;sb: Verify, replace Alice B with Alice A
sb-&gt;&gt;ab: New account data
sa-&gt;&gt;sa: Deactivate Alice A's account
sa-&gt;&gt;sa: Setup redirect from Alice A to Alice B</code></pre>
Fig. 7: Sequence diagram depicting a successful migration of Alice A's account to Alice B's account, where Server A is reachable and cooperative.</p>
<p>Alternatively, if Server A is offline or deemed uncooperative, the following sequence diagram depicts how the migration can be done without Server A's cooperation:</p>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor aa as Alice A
actor ab as Alice B
participant sa as Server A
participant sb as Server B

ab-&gt;&gt;sb: Migration request (Signed, Alice B-&gt;Server B)
aa-&gt;&gt;sb: Migration request (Signed, Alice A-&gt;Server B)
sb-&gt;&gt;sa: Fetch full profile of Alice A,&lt;br /&gt;attached with migration request
sa--xsb: Server A offline send profile or abort?
aa-&gt;&gt;sb: Full profile of Self
sb-&gt;&gt;sb: Verify, replace Alice B profile with Alice A
sb-&gt;&gt;ab: New account data
</code></pre>
Fig. 8: Sequence diagram depicting a successful migration of Alice A's account to Alice B's account, where Server A is unreachable or uncooperative.</p>
<div class="admonition question">
<p class="admonition-title">If the old home server is not needed for the migration, why try to contact it in the first place?</p>
<p>It is generally preferrable to have the old home server cooperate with the migration, as it
allows for a more seamless migration. A cooperative homeserver will be able to provide the new
home server with all information associated with the old account. It can also forward requests
regarding the old account to the new server, which makes the process more seamless for other
users. The "non-cooperative homeserver migration method" is only a last resort.</p>
</div>
<h4 id="812-re-signing-data">8.1.2 Re-signing data<a class="headerlink" href="#812-re-signing-data" title="Permanent link">&para;</a></h4>
<p>Transferring message ownership from an old to a new account, known as re-signing messages, necessitates
coordination between the two accounts, initiated by the old account. To start, the old account sends
an API request containing the new account's federation ID to the server where messages should be
re-signed. The server responds with all ID-Certs used for signing the old account's messages, along with
a challenge string. The old account will then need to prove that it is in possession of the private
keys that were used to sign the messages. This is done by signing a challenge string with the private
keys. If the server verifies the challenge, it authorizes the new account to re-sign the old
account's messages signed with the verified key. Instead of overwriting the message, a new message variant
with the new signature is created, preserving the old message.</p>
<p>Implementations and protocol extensions should carefully consider the extent of messages that can be
re-signed.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>In the case of a social media platform with quote-posting functionality, it is reasonable to
assume that re-signing a quoted post is allowed. However, this would likely change the
signature of the quoted post, which would be undesirable. Edge cases like these are up to
implementations to handle, and should be well documented.</p>
</div>
<p><pre class="mermaid"><code>sequenceDiagram
autonumber

actor aa as Alice A
actor ab as Alice B
participant sc as Server C

aa-&gt;&gt;sc: Request allow message re-signing for Alice B
sc-&gt;&gt;aa: List of keys to verify + challenge string
aa-&gt;&gt;sc: Completed challenge for each key on the list
sc-&gt;&gt;sc: Verify challenge, unlock re-signing for Alice B
ab-&gt;&gt;sc: Request message re-signing for Alice A's messages
sc-&gt;&gt;ab: List of old messages (including old signatures + certificates)
ab-&gt;&gt;ab: Verify that Server C has not tampered with messages
ab-&gt;&gt;ab: Re-sign messages with own keys
ab-&gt;&gt;sc: Send new messages
sc-&gt;&gt;sc: Verify that only FID and signature related fields have changed</code></pre>
Fig. 9: Sequence diagram depicting the re-signing procedure.</p>
<h3 id="82-moving-data">8.2 Moving data<a class="headerlink" href="#82-moving-data" title="Permanent link">&para;</a></h3>
<p>In cases of an imminent server shutdown or distrust in the old server, moving data from the old server
is necessary to prevent data loss. This process extends upon the reassigning ownership process, and
involves the following steps:</p>
<ol>
<li>Using the old account, the client requests a data export from your old home server.</li>
<li>The old home server sends a data export to the client. The client will check the signatures on
   the exported data, to ensure it was not tampered with.</li>
<li>The new account re-signs the data with its own keys and imports it into the new home server.</li>
<li>The new home server verifies the data and signals that the import was successful.</li>
<li>The old client requests the deactivation or deletion of the old account on the old home server.</li>
</ol>
<pre class="mermaid"><code>sequenceDiagram
autonumber

participant sa as Server A
participant sb as Server B
box Same Device
actor aa as Alice A
actor ab as Alice B
end 

aa-&gt;&gt;sa: Request data export
sa-&gt;&gt;aa: Data export
aa-&gt;ab: Data shared on device
ab-&gt;&gt;ab: Verify data integrity
ab-&gt;&gt;ab: Re-sign data
ab-&gt;&gt;sb: Request data import
sb-&gt;&gt;sb: Verify data integrity
sb-&gt;&gt;ab: Data import successful
aa-xsa: Deactivate account</code></pre>
<h2 id="glossary">Glossary<a class="headerlink" href="#glossary" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Actor</strong> - An entity represented by a federation ID, registered on a home server. Actors can be users, bots, or any other entity with an identity.</li>
<li><strong>Client</strong> - Any application used by an actor to connect to a server.</li>
<li><strong>Federation ID</strong> - A unique identifier; In public contexts, usually <code>username@optionalsubdomain.domain.tld</code></li>
<li><strong>Foreign client</strong> - Any client authenticated on a server that is not its home server.</li>
<li><strong>Foreign server</strong> - A server that an actor is not registered on; essentially a third party.</li>
<li><strong>Home client</strong> - Any client registered and authenticated on its home server.</li>
<li><strong>Home server</strong> - The server that an actor is registered on. Any polyproto-core compliant server hosted on the same domain is also considered a home server.</li>
<li><strong>Identity</strong> - A unique Federation ID.</li>
<li><strong>Identity Key</strong> - A key pair representing an actor's identity in a session, used for signing and encrypting messages.</li>
<li><strong>Instance</strong> - A server hosting polyproto compliant software for clients.</li>
<li><strong>polyproto-chat</strong> - The chat-API used by Polyphony. An extension of the polyproto protocol, defining the routes and capabilities of the chat-API used by Polyphony.</li>
<li><strong>polyproto</strong> - The core federation protocol and APIs of polyproto, enabling identification and authorization on 'foreign' servers. It is independent of the chat-API used.</li>
<li><strong>Root Certificate</strong> - A certificate used to sign other certificates, establishing a chain of trust. In polyproto, only home servers have root certificates.</li>
<li><strong>Session</strong> - A specific period of interaction between a client and a server, typically identified and authenticated by the use of an identity key. The session begins when the client connects to the server and ends when the client disconnects. During a session, the client can interact with the server (e.g., send messages, make requests) under the identity associated with the session.</li>
</ul>
<p><strong>The below creation- and update-times are not accurate. This is only an issue on this page. Please have a look at the <a href="https://github.com/polyphony-chat/polyproto/commits/main/SPECIFICATION.md">commit history</a> to view when this document was last updated.</strong></p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-02-01T15:09:39+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-02-01</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2023-12-23T17:48:43+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-12-23</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "toc.follow", "navigation.top", "search.suggest", "content.tooltips", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="../../assets/external/unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
    
  </body>
</html>